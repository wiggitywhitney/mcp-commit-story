# MCP Commit Story Architecture

## Overview

MCP Commit Story follows a **background generation architecture** with automatic journal creation triggered by git commits. This design prioritizes seamless workflow integration and user control over manual operations.

## Architecture Rationale

### Why Background Generation?

1. **Workflow Respect**: No interruption to development flow - journal entries are created silently after commits
2. **Fresh Context**: Each journal entry is generated by a fresh AI agent with comprehensive context, ensuring quality without dependency on persistent state
3. **User Control**: Developers control when and how context is added through manual reflection tools and context capture
4. **Reliability**: Direct git hook execution eliminates complex intermediate mechanisms and dependency chains
5. **Simplicity**: Clear, linear flow from commit → context collection → journal generation

### Core Architecture

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Git Commit    │    │ Standalone       │    │   Journal       │
│   (Trigger)     │───▶│ Generator        │───▶│   Entry         │
│                 │    │ (Background)     │    │   Created       │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌──────────────────┐
                       │ Context Sources  │
                       │ • Git diff/log   │
                       │ • Chat history   │
                       │ • Recent journals│
                       │ • Project README │
                       └──────────────────┘
```

## Background Generation Flow

### 1. Git Hook Trigger
- **Post-commit hook** executes after each commit
- **Direct execution** of standalone journal generator
- **No intermediate files** or complex coordination required
- **Never blocks** git operations

### 2. Context Collection
- **Git Context**: Commit metadata, diffs, file changes (always available)
- **Chat History**: Cursor SQLite database extraction with intelligent filtering
- **Recent Journals**: Today's journal + 2 most recent daily entries for continuity
- **Project Context**: README (or configured overview file) ensures AI always understands project goals

### 3. Intelligent Chat Parsing
- **Git-driven filtering**: Extract keywords and concepts from git diffs
- **Relevance scoring**: Match chat content against code changes
- **Boundary detection**: Identify relevant chat sessions and conversations
- **Context optimization**: Return only chat segments related to the work

### 4. Fresh AI Generation
- **New AI instance** for each journal entry (no persistent context)
- **Comprehensive input**: All collected context provided to AI
- **Structured output**: Human-readable + machine-tagged journal entries
- **Quality focus**: Grounded in real data, captures emotion and decisions

### 5. Automatic Summaries
- **Daily summaries**: Generated automatically when date boundaries are detected
- **Future summaries**: Weekly, monthly, quarterly, yearly (planned)
- **Same pattern**: Background generation using recent journal entries as input

## MCP Server Role

The MCP server provides **interactive tools only**:

### User-Controlled Operations
- **journal/add-reflection**: Add manual thoughts and reflections
- **journal/capture-context**: Capture AI assistant's current knowledge
- **journal/generate-summary**: Manual summary generation (if needed)

### Setup Operations  
- **journal/init**: Initialize journal structure
- **journal/install-hook**: Install git hooks

**Key Point**: The MCP server is NOT required for core journal generation - it runs independently in the background.

## 4-Layer Background Generation Architecture

The journal generation process still follows a **4-layer architecture**, but with git hooks replacing the MCP server as the trigger:

### Layer 1: Git Hook Trigger (Replaces MCP Server)
- **Entry Point**: Post-commit git hook
- **Responsibility**: Detect commits and trigger standalone journal generator
- **Key Function**: Direct execution of `generate_journal_entry(commit_hash)`

### Layer 2: Orchestration (Coordination + Context Collection)
- **Module**: Standalone journal generator
- **Responsibility**: Coordinate all phases of journal generation
- **Key Functions**:
  - `generate_journal_entry()` - Main orchestration function
  - `collect_git_context()` - Git metadata and diff extraction
  - `collect_and_filter_chat_history()` - Intelligent chat extraction
  - `load_recent_journal_entries()` - Journal context loading
  - `load_project_overview()` - README/project context loading

### Layer 3: Context Processing (Data Filtering & Preparation)
- **Responsibility**: Process and filter collected context for AI consumption
- **Key Functions**:
  - `extract_keywords_from_diff()` - Git diff analysis for chat filtering
  - `filter_by_relevance()` - Chat relevance scoring and filtering
  - `prepare_ai_context()` - Context assembly and optimization

### Layer 4: Content Generation (Fresh AI Invocation)
- **Responsibility**: Generate journal entry using fresh AI agent
- **Key Functions**:
  - `invoke_ai_generation()` - Fresh AI agent with comprehensive context
  - `write_journal_entry()` - File writing and formatting
  - `generate_daily_summary()` - Summary generation when needed

### Standalone Journal Generator (Layer 2 Implementation)
```python
def generate_journal_entry(commit_hash: str) -> None:
    """Main entry point called by git hook"""
    # 1. Collect git context
    git_context = collect_git_context(commit_hash)
    
    # 2. Extract relevant chat history  
    chat_history = collect_and_filter_chat_history(git_context)
    
    # 3. Load recent journal context
    journal_context = load_recent_journal_entries()
    
    # 4. Load project overview (README by default)
    project_context = load_project_overview()  # Ensures AI understands project goals
    
    # 5. Generate journal entry with fresh AI
    entry = invoke_ai_generation({
        'git': git_context,
        'chat': chat_history, 
        'journals': journal_context,
        'project': project_context
    })
    
    # 6. Write journal entry
    write_journal_entry(entry)
```

### Chat Collection & Filtering (Layer 3 Implementation)
```python
def collect_and_filter_chat_history(git_context: GitContext) -> ChatHistory:
    """Intelligent chat extraction based on git changes"""
    # 1. Extract keywords from git diff
    keywords = extract_keywords_from_diff(git_context.diff)
    
    # 2. Query Cursor SQLite database
    raw_chat = query_cursor_database()
    
    # 3. Score relevance against git changes
    relevant_chat = filter_by_relevance(raw_chat, keywords)
    
    return relevant_chat
```

## Benefits of This Architecture

### For Developers
- **Zero Friction**: Commit and forget - journal entries appear automatically
- **No Workflow Disruption**: Background generation never interrupts work
- **Full Control**: Add context when needed, ignore when focused
- **Rich Context**: Every entry has comprehensive, relevant information

### For Quality
- **Fresh Perspective**: Each entry generated by new AI instance with full context
- **Grounded Content**: All entries based on real git changes and conversations  
- **Intelligent Filtering**: Only relevant chat history included
- **Consistent Format**: Standardized structure across all entries

### For Reliability
- **Simple Flow**: Linear execution path with clear error boundaries
- **No Dependencies**: Core functionality works without MCP server
- **Graceful Degradation**: Works even if some context sources fail
- **Fast Execution**: Optimized for quick background processing

## User Experience Patterns

### Automatic Operation (Primary)
```bash
# Developer works normally
git add .
git commit -m "Implement user authentication"
# → Journal entry automatically created in background
# → Daily summary generated if date boundary crossed
```

### Manual Context Addition (When Needed)
```bash
# Via MCP tools in editor/AI assistant
journal/add-reflection "Learned about JWT security considerations"
journal/capture-context  # Captures current AI conversation context
```

### Summary Generation
```bash
# Automatic daily summaries when date changes
# Manual generation available via MCP if needed
journal/generate-summary --type=daily --date=2025-06-14
```

## Future Architecture Considerations

### Planned Enhancements
- **Multi-timeframe summaries**: Weekly, monthly, quarterly, yearly
- **Pattern recognition**: Identify recurring themes and challenges
- **Content suggestions**: Recommend blog post topics from journal patterns
- **Integration hooks**: Export to external systems (blogs, documentation)

### Scalability
- **Repository isolation**: Each repo maintains independent journal
- **Context optimization**: Intelligent pruning of large chat histories
- **Performance monitoring**: Telemetry for background generation timing
- **Resource management**: Configurable limits for AI processing

## Related Documentation

- **[MCP API Specification](mcp-api-specification.md)** - Interactive tool reference
- **[Implementation Guide](implementation-guide.md)** - Technical implementation details
- **[Journal Behavior](journal-behavior.md)** - Content generation rules
- **[Context Collection](context-collection.md)** - Data gathering system
- **[Testing Standards](testing_standards.md)** - Quality assurance